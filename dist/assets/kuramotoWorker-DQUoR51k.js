(function(){"use strict";const W=["rim","surface","phase","volume"],tt=(t,e)=>({width:t,height:e,texels:t*e}),et={rim:0,surface:1,phase:2,volume:3},nt={planar:0,interleaved:1},at={float32:0,uint8:1},ot={static:0,dynamic:1,workerStream:2},st={gradientX:0,gradientY:1,magnitude:2,baseR:3,baseG:4,baseB:5,baseA:6,phaseGradX:7,phaseGradY:8,phaseVorticity:9,phaseCoherence:10,volumeReal:11,volumeImag:12},y=t=>t.replace(/([a-z0-9])([A-Z])/g,"$1_$2").replace(/[-\s]+/g,"_").toUpperCase(),rt=()=>Object.entries(st).map(([t,e])=>`#define FIELD_SEMANTIC_${y(t)} ${e}`).join(`
`),it=()=>W.map(t=>`#define FIELD_KIND_${y(t)} ${et[t]}`).join(`
`),ct=()=>Object.entries(nt).map(([t,e])=>`#define FIELD_STORAGE_${y(t)} ${e}`).join(`
`),lt=()=>Object.entries(at).map(([t,e])=>`#define FIELD_FORMAT_${y(t)} ${e}`).join(`
`),ht=()=>Object.entries(ot).map(([t,e])=>`#define FIELD_LIFETIME_${y(t)} ${e}`).join(`
`);`${it()}${ct()}${lt()}${ht()}${rt()}`;const ut=(t,e)=>{if(!t)throw new Error(e)},C=(t,e,n,a,o)=>{ut(t.length===e,`[fields:${a}] ${n} length ${t.length} != expected ${e} (${o})`)},P=(t,e)=>{const n=t.resolution.texels;C(t.gradX,n,"gradX","phase",e),C(t.gradY,n,"gradY","phase",e),C(t.vort,n,"vort","phase",e),C(t.coh,n,"coh","phase",e),C(t.amp,n,"amp","phase",e)},dt=(t,e,n)=>Math.max(e,Math.min(n,t)),ft=t=>dt(t,0,1),E=t=>{let e=t;for(;e>Math.PI;)e-=2*Math.PI;for(;e<=-Math.PI;)e+=2*Math.PI;return e},I=(t,e,n,a)=>{const o=(t%n+n)%n;return(e%a+a)%a*n+o},K=(t,e)=>{const n=t*e;return{width:t,height:e,Zr:new Float32Array(n),Zi:new Float32Array(n)}},pt=5,mt=(t,e)=>t*e*pt*Float32Array.BYTES_PER_ELEMENT,O=(t,e,n)=>{const a=e*n,o=new Float32Array(t),s=o.subarray(0,a),l=o.subarray(a,a*2),r=o.subarray(a*2,a*3),h=o.subarray(a*3,a*4),b=o.subarray(a*4,a*5);return{kind:"phase",resolution:tt(e,n),gradX:s,gradY:l,vort:r,coh:h,amp:b}},x=(t,e,n)=>{const{width:a,height:o,Zr:s,Zi:l}=t;for(let r=0;r<o;r++)for(let h=0;h<a;h++){const b=2*Math.PI*e*h/a,F=r*a+h;s[F]=Math.cos(b),l[F]=Math.sin(b)}},R=(t,e,n,a)=>{const{width:o,height:s,Zr:l,Zi:r}=t,{alphaKur:h,gammaKur:b,omega0:F,K0:d,epsKur:i}=e,c=Math.cos(h),f=Math.sin(h);for(let p=0;p<s;p++)for(let m=0;m<o;m++){const M=p*o+m,k=I(m-1,p,o,s),w=I(m+1,p,o,s),v=I(m,p-1,o,s),S=I(m,p+1,o,s),N=.2*(l[M]+l[k]+l[w]+l[v]+l[S]),Z=.2*(r[M]+r[k]+r[w]+r[v]+r[S]),_=l[M],g=r[M],z=_*_-g*g,G=2*_*g,gt=c*N+f*Z,yt=-f*N+c*Z,X=N,U=-Z,V=z*X-G*U,J=z*U+G*X,Ct=c*V-f*J,Dt=f*V+c*J,$t=-b*_-F*g+.5*d*(gt-Ct),Lt=-b*g+F*_+.5*d*(yt-Dt),Q=Math.sqrt(Math.max(n*i,0));l[M]=_+n*$t+Q*a(),r[M]=g+n*Lt+Q*a()}},j=(t,e)=>{const{width:n,height:a,Zr:o,Zi:s}=t,{gradX:l,gradY:r,vort:h,coh:b,amp:F}=e,d=i=>Math.atan2(s[i],o[i]);for(let i=0;i<a;i++)for(let c=0;c<n;c++){const f=i*n+c,p=I(c-1,i,n,a),m=I(c+1,i,n,a),M=I(c,i-1,n,a),k=I(c,i+1,n,a);l[f]=.5*E(d(m)-d(p)),r[f]=.5*E(d(k)-d(M));const w=Math.hypot(o[f],s[f]);F[f]=w,b[f]=ft(w)}for(let i=0;i<a;i++)for(let c=0;c<n;c++){const f=i*n+c,p=I(c+1,i,n,a),m=I(c+1,i+1,n,a),M=I(c,i+1,n,a),k=E(d(p)-d(f)),w=E(d(m)-d(p)),v=E(d(M)-d(m)),S=E(d(f)-d(M));h[f]=(k+w+v+S)/(2*Math.PI)}},It=t=>{let e=t>>>0;return()=>{e+=1831565813;let n=Math.imul(e^e>>>15,1|e);return n^=n+Math.imul(n^n>>>7,61|n),((n^n>>>14)>>>0)/4294967296}},A=t=>{const e=t==null?Math.random:It(t);let n=null;return()=>{if(n!=null){const h=n;return n=null,h}let a=0,o=0;for(;a===0;)a=e();for(;o===0;)o=e();const s=Math.sqrt(-2*Math.log(a)),l=s*Math.cos(2*Math.PI*o);return n=s*Math.sin(2*Math.PI*o),l}},T=self;let u=null,$=null,H=A(),L=[],q=0,B=0;const D=(t,e)=>{e?T.postMessage(t,e):T.postMessage(t)},Mt=(t,e)=>{(!u||u.width!==t||u.height!==e)&&(u=K(t,e))},Y=t=>{H=A(t)},bt=()=>L.shift()??null,Ft=t=>{L.push(t)},wt=t=>{if(!u||!$)return;const e=bt();if(!e){D({kind:"log",message:"[kur-worker] dropping frame: buffer pool empty"});return}R(u,$,t.dt,H);const n=O(e,u.width,u.height);P(n,"worker:tick"),j(u,n),D({kind:"frame",buffer:e,timestamp:t.timestamp,frameId:t.frameId,queueDepth:L.length},[e])},Et=t=>{q=t.width,B=t.height,$={...t.params},Mt(q,B),Y(t.seed),L=[...t.buffers],u&&(x(u,t.qInit),D({kind:"ready",width:u.width,height:u.height}))},kt=t=>{u&&(Y(t.seed),x(u,t.qInit))},_t=t=>{const e=K(t.width,t.height),n={...t.params},a=A(t.seed);x(e,t.qInit);const o=mt(t.width,t.height),s=[];for(let l=0;l<t.frameCount;l++){R(e,n,t.dt,a);const r=new ArrayBuffer(o),h=O(r,t.width,t.height);P(h,"worker:simulate"),j(e,h),s.push(r)}D({kind:"simulateResult",buffers:s,width:t.width,height:t.height,frameCount:t.frameCount},s)};T.onmessage=t=>{const e=t.data;switch(e.kind){case"init":Et(e);break;case"tick":wt(e);break;case"updateParams":$={...e.params};break;case"reset":kt(e);break;case"returnBuffer":Ft(e.buffer);break;case"simulate":_t(e);break;default:D({kind:"log",message:`[kur-worker] unhandled message ${e==null?void 0:e.kind}`});break}}})();
